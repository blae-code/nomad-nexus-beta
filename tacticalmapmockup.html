<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stanton Tactical Operations Map</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&amp;family=Orbitron:wght@400;700;900&amp;display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    
    :root {
      --primary: #00ff00;
      --secondary: #0a0e1a;
      --accent: #ffff00;
      --warning: #ff4444;
      --danger: #ff0000;
      --text: #ffffff;
    }
    
    body {
      font-family: 'Share Tech Mono', monospace;
      background: var(--secondary);
      color: var(--text);
    }
    
    .orbitron { font-family: 'Orbitron', sans-serif; }
    
    /* CRT scanline effect */
    .crt-overlay {
      pointer-events: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 255, 0, 0.05) 2px,
        rgba(0, 255, 0, 0.05) 4px
      );
      z-index: 9999;
    }
    
    .crt-flicker {
      animation: flicker 0.15s infinite;
    }
    
    @keyframes flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.98; }
    }
    
    /* Glowing effects */
    .glow-primary {
      text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary), 0 0 30px var(--primary);
    }
    
    .glow-box {
      box-shadow: 0 0 10px var(--primary), inset 0 0 20px rgba(0, 255, 0, 0.1);
    }
    
    .glow-accent {
      box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent);
    }
    
    /* Terminal frame */
    .terminal-frame {
      border: 2px solid var(--primary);
      background: linear-gradient(135deg, rgba(10, 14, 26, 0.95) 0%, rgba(5, 10, 20, 0.98) 100%);
      position: relative;
    }
    
    .terminal-frame::before {
      content: '';
      position: absolute;
      top: -1px; left: -1px; right: -1px; bottom: -1px;
      border: 1px solid rgba(0, 255, 0, 0.3);
      pointer-events: none;
    }
    
    /* Corner decorations */
    .corner-tl::before, .corner-tr::before, .corner-bl::before, .corner-br::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid var(--primary);
    }
    
    .corner-tl::before { top: -2px; left: -2px; border-right: none; border-bottom: none; }
    .corner-tr::before { top: -2px; right: -2px; border-left: none; border-bottom: none; }
    .corner-bl::before { bottom: -2px; left: -2px; border-right: none; border-top: none; }
    .corner-br::before { bottom: -2px; right: -2px; border-left: none; border-top: none; }
    
    /* Map container */
    .map-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      cursor: grab;
    }
    
    .map-container:active { cursor: grabbing; }
    
    .map-content {
      position: absolute;
      transform-origin: center center;
      transition: transform 0.1s ease-out;
    }
    
    /* Celestial bodies */
    .celestial-body {
      position: absolute;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      transform: translate(-50%, -50%);
    }
    
    .celestial-body:hover {
      filter: brightness(1.5);
      z-index: 100;
    }
    
    .celestial-body::after {
      content: attr(data-name);
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      white-space: nowrap;
      color: var(--text);
      text-shadow: 0 0 5px var(--secondary);
    }
    
    /* Stars */
    .star {
      background: radial-gradient(circle, #ffff99 0%, #ffff00 30%, #ffaa00 70%, #ff6600 100%);
      box-shadow: 0 0 60px #ffff00, 0 0 100px #ffaa00, 0 0 150px rgba(255, 200, 0, 0.7);
      animation: starPulse 4s ease-in-out infinite;
    }
    
    @keyframes starPulse {
      0%, 100% { box-shadow: 0 0 60px #ffff00, 0 0 100px #ffaa00, 0 0 150px rgba(255, 200, 0, 0.7); }
      50% { box-shadow: 0 0 80px #ffff00, 0 0 120px #ffaa00, 0 0 180px rgba(255, 200, 0, 0.9); }
    }
    
    /* Planets */
    .planet-crusader {
      background: radial-gradient(circle at 30% 30%, #66ccff, #0066cc 50%, #003366);
      box-shadow: 0 0 20px rgba(102, 204, 255, 0.8), inset -10px -10px 30px rgba(0,0,0,0.6);
    }
    
    .planet-hurston {
      background: radial-gradient(circle at 30% 30%, #ff9966, #cc6633 50%, #663300);
      box-shadow: 0 0 20px rgba(255, 153, 102, 0.8), inset -10px -10px 30px rgba(0,0,0,0.6);
    }
    
    .planet-arccorp {
      background: radial-gradient(circle at 30% 30%, #88ff00, #66cc00 50%, #336600);
      box-shadow: 0 0 20px rgba(136, 255, 0, 0.8), inset -10px -10px 30px rgba(0,0,0,0.6);
    }
    
    .planet-microtech {
      background: radial-gradient(circle at 30% 30%, #66ffff, #3399cc 50%, #003366);
      box-shadow: 0 0 20px rgba(102, 255, 255, 0.8), inset -10px -10px 30px rgba(0,0,0,0.6);
    }
    
    /* Moons */
    .moon {
      background: radial-gradient(circle at 30% 30%, #cccccc, #888888 50%, #444444);
      box-shadow: 0 0 10px rgba(200, 200, 200, 0.5), inset -3px -3px 10px rgba(0,0,0,0.7);
    }
    
    .moon::after {
      font-size: 8px;
      bottom: -15px;
    }
    
    /* Orbital rings */
    .orbit-ring {
      position: absolute;
      border: 1px dashed rgba(0, 255, 0, 0.4);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    
    /* OM Markers */
    .om-marker {
      position: absolute;
      width: 12px;
      height: 12px;
      transform: translate(-50%, -50%) rotate(45deg);
      border: 2px solid var(--primary);
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .om-marker:hover {
      background: var(--primary);
      box-shadow: 0 0 15px var(--primary);
    }
    
    .om-marker::after {
      content: attr(data-name);
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%) rotate(-45deg);
      font-size: 8px;
      white-space: nowrap;
      color: var(--primary);
    }
    
    /* Lagrange Points */
    .lagrange-point {
      position: absolute;
      width: 16px;
      height: 16px;
      transform: translate(-50%, -50%);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .lagrange-point svg {
      width: 100%;
      height: 100%;
      fill: var(--accent);
      filter: drop-shadow(0 0 8px var(--accent));
    }
    
    .lagrange-point:hover svg {
      filter: drop-shadow(0 0 15px var(--accent));
      transform: scale(1.2);
    }
    
    .lagrange-point::after {
      content: attr(data-name);
      position: absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 8px;
      white-space: nowrap;
      color: var(--accent);
    }
    
    /* Jump Points */
    .jump-point {
      position: absolute;
      width: 24px;
      height: 24px;
      transform: translate(-50%, -50%);
      cursor: pointer;
      animation: jumpPulse 2s ease-in-out infinite;
    }
    
    .jump-point::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border: 2px solid var(--warning);
      border-radius: 50%;
      animation: jumpRing 2s ease-in-out infinite;
    }
    
    .jump-point::after {
      content: attr(data-name);
      position: absolute;
      top: 28px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 9px;
      white-space: nowrap;
      color: var(--warning);
    }
    
    @keyframes jumpPulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    @keyframes jumpRing {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5); opacity: 0.4; }
    }
    
    /* Unit markers */
    .unit-marker {
      position: absolute;
      transform: translate(-50%, -50%);
      cursor: pointer;
      z-index: 50;
      transition: all 0.2s;
    }
    
    .unit-marker:hover { z-index: 200; }
    .unit-marker.selected .unit-icon {
      box-shadow: 0 0 12px var(--accent), 0 0 20px var(--primary);
      transform: scale(1.1);
    }
    
    .unit-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
      border: 2px solid;
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    }
    
    .unit-friendly { border-color: var(--primary); background: rgba(0, 255, 0, 0.4); color: var(--primary); }
    .unit-hostile { border-color: var(--danger); background: rgba(255, 0, 0, 0.4); color: var(--danger); }
    .unit-neutral { border-color: var(--accent); background: rgba(255, 255, 0, 0.3); color: var(--accent); }
    
    .unit-marker::after {
      content: attr(data-callsign);
      position: absolute;
      top: 22px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 8px;
      white-space: nowrap;
      padding: 1px 4px;
      background: rgba(10, 14, 26, 0.9);
      border: 1px solid currentColor;
    }
    
    /* Radial Menu */
    .radial-menu {
      position: fixed;
      width: 200px;
      height: 200px;
      transform: translate(-50%, -50%);
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .radial-menu.active {
      pointer-events: auto;
      opacity: 1;
    }
    
    .radial-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(10, 14, 26, 0.95);
      border: 2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      text-align: center;
      z-index: 10;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.6);
    }
    
    .radial-option {
      position: absolute;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(10, 14, 26, 0.95);
      border: 2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.4);
    }
    
    .radial-option:hover {
      background: var(--primary);
      color: var(--secondary);
      transform: translate(-50%, -50%) scale(1.15);
      box-shadow: 0 0 20px var(--primary);
    }
    
    .radial-option.danger { border-color: var(--danger); }
    .radial-option.danger:hover { background: var(--danger); box-shadow: 0 0 20px var(--danger); }
    
    .radial-option.warning { border-color: var(--accent); }
    .radial-option.warning:hover { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent); }

    .selection-marquee {
      position: absolute;
      border: 1px dashed var(--accent);
      background: rgba(255, 255, 0, 0.12);
      pointer-events: none;
      z-index: 120;
      display: none;
    }

    .selection-toast {
      position: fixed;
      top: 56px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      padding: 4px 10px;
      border: 1px solid var(--accent);
      background: rgba(10, 14, 26, 0.95);
      color: var(--accent);
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      z-index: 1200;
    }

    .selection-toast.show {
      opacity: 1;
    }

    .pager-row {
      margin-top: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      font-size: 10px;
      opacity: 0.75;
    }

    .pager-btn {
      min-width: 24px;
      height: 20px;
      border: 1px solid var(--primary);
      background: rgba(10, 14, 26, 0.82);
      color: var(--primary);
      cursor: pointer;
      font-family: inherit;
      font-size: 10px;
      line-height: 1;
    }

    .pager-btn:disabled {
      opacity: 0.35;
      cursor: default;
    }

    .unit-order-badge {
      position: absolute;
      top: 34px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 8px;
      line-height: 1;
      padding: 1px 3px;
      border: 1px solid var(--accent);
      background: rgba(10, 14, 26, 0.95);
      color: var(--accent);
      white-space: nowrap;
      z-index: 220;
      cursor: pointer;
    }

    .unit-order-badge.acked {
      border-color: var(--primary);
      color: var(--primary);
      cursor: default;
    }

    .unit-order-badge.pending {
      animation: unitAckBlink 1.4s ease-in-out infinite;
    }

    @keyframes unitAckBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    /* Status indicators */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    
    .status-online { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
    .status-combat { background: var(--danger); box-shadow: 0 0 8px var(--danger); animation: pulse 1s infinite; }
    .status-offline { background: #555; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Grid overlay */
    .grid-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: 
        linear-gradient(rgba(0, 255, 0, 0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 0, 0.08) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
    }
    
    /* Data readouts */
    .data-panel {
      background: rgba(10, 14, 26, 0.95);
      border: 1px solid var(--primary);
      padding: 10px;
      font-size: 11px;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
    }
    
    .data-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      border-bottom: 1px solid rgba(0, 255, 0, 0.2);
      padding-bottom: 4px;
    }
    
    .data-label { color: rgba(0, 255, 0, 0.6); }
    .data-value { color: var(--primary); font-weight: bold; }
    
    /* Layer buttons */
    .layer-btn {
      padding: 6px 12px;
      background: rgba(10, 14, 26, 0.8);
      border: 1px solid var(--primary);
      color: var(--text);
      font-family: inherit;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
    }
    
    .layer-btn:hover, .layer-btn.active {
      background: var(--primary);
      color: var(--secondary);
      box-shadow: 0 0 15px var(--primary);
    }
    
    /* Comms network lines */
    .comms-line {
      stroke: var(--accent);
      stroke-width: 1.5;
      stroke-dasharray: 5, 5;
      fill: none;
      opacity: 0.7;
      animation: commsPulse 2s linear infinite;
    }
    
    @keyframes commsPulse {
      0% { stroke-dashoffset: 0; }
      100% { stroke-dashoffset: -20; }
    }
    
    /* Zoom controls */
    .zoom-controls {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .zoom-btn {
      width: 30px;
      height: 30px;
      background: rgba(10, 14, 26, 0.95);
      border: 1px solid var(--primary);
      color: var(--primary);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
    }
    
    .zoom-btn:hover {
      background: var(--primary);
      color: var(--secondary);
      box-shadow: 0 0 20px var(--primary);
    }
    
    /* Minimap */
    .minimap {
      width: 150px;
      height: 150px;
      background: rgba(10, 14, 26, 0.95);
      border: 1px solid var(--primary);
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
    }
    
    .minimap-viewport {
      position: absolute;
      border: 1px solid var(--accent);
      background: rgba(255, 255, 0, 0.15);
      pointer-events: none;
    }
    
    .minimap-dot {
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }
    
    /* Scrollbars */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--secondary); }
    ::-webkit-scrollbar-thumb { background: var(--primary); }
    
    /* Noise texture */
    .noise-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 9998;
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full flex flex-col"><!-- Header Bar -->
   <header class="terminal-frame border-b-0 px-4 py-2 flex items-center justify-between relative z-50">
    <div class="flex items-center gap-4">
     <div class="flex items-center gap-2">
      <svg width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke="var(--primary)" /> <circle cx="12" cy="12" r="3" fill="var(--primary)" /> <line x1="12" y1="2" x2="12" y2="6" stroke="var(--primary)" /> <line x1="12" y1="18" x2="12" y2="22" stroke="var(--primary)" /> <line x1="2" y1="12" x2="6" y2="12" stroke="var(--primary)" /> <line x1="18" y1="12" x2="22" y2="12" stroke="var(--primary)" />
      </svg><span class="orbitron font-bold text-lg glow-primary" id="operationName">STANTON TACTICAL OPS</span>
     </div>
     <div class="text-xs opacity-60"><span id="systemTime">2954.03.15 // 14:32:07 SET</span>
     </div>
    </div>
    <div class="flex items-center gap-4">
     <div class="flex items-center gap-2 text-xs"><span class="status-dot status-online"></span> <span id="fleetCallsign">VANGUARD ACTUAL</span>
     </div>
     <div class="text-xs px-2 py-1 border border-current" style="color: var(--accent); text-shadow: 0 0 10px var(--accent);">
      DEFCON 3
     </div>
    </div>
   </header><!-- Main Content -->
   <div class="flex-1 flex overflow-hidden"><!-- Left Sidebar -->
    <aside class="w-64 terminal-frame border-t-0 flex flex-col overflow-hidden">
     <div class="p-3 border-b border-current opacity-50">
      <div class="orbitron text-xs mb-2 opacity-70" style="color: var(--accent);">
       // LAYER CONTROLS
      </div>
     <div class="flex flex-wrap gap-2"><button class="layer-btn active" data-layer="celestial">CELESTIAL</button> <button class="layer-btn active" data-layer="markers">NAV MARKERS</button> <button class="layer-btn active" data-layer="units">UNITS</button> <button class="layer-btn" data-layer="comms">COMMS NET</button> <button class="layer-btn" data-layer="zones">AO ZONES</button>
      </div>
     </div>
     <div class="p-3 border-b border-current opacity-50">
      <div class="orbitron text-xs mb-2 opacity-70" style="color: var(--accent);">
       // SELECT BY
      </div>
      <div class="flex gap-2">
       <button class="layer-btn" data-select-by="wing">WING: ALL</button>
       <button class="layer-btn" data-select-by="role">ROLE: ALL</button>
       <button class="layer-btn" data-select-by="status">STATUS: ALL</button>
      </div>
     </div>
     <div class="p-3 border-b border-current opacity-50">
      <div class="orbitron text-xs mb-2 opacity-70" style="color: var(--accent);">
       // VIEW MODE
      </div>
      <div class="flex gap-2"><button class="layer-btn active" data-view="system">SYSTEM</button> <button class="layer-btn" data-view="planet">PLANETARY</button> <button class="layer-btn" data-view="local">LOCAL</button>
      </div>
     </div>
     <div class="flex-1 p-3 overflow-hidden">
      <div class="orbitron text-xs mb-2 opacity-70" style="color: var(--accent);">
       // FLEET ROSTER
      </div>
      <div id="fleetRoster" class="space-y-2 text-xs"><!-- Populated by JS -->
      </div>
      <div class="pager-row">
       <button class="pager-btn" id="fleetRosterPrev">◀</button><span id="fleetRosterPage">1/1</span><button class="pager-btn" id="fleetRosterNext">▶</button>
      </div>
     </div>
     <div class="p-3 border-t border-current opacity-50">
      <div class="minimap" id="minimap">
       <div class="minimap-viewport" id="minimapViewport"></div>
      </div>
     </div>
    </aside><!-- Map Area -->
    <main class="flex-1 relative overflow-hidden" style="background: radial-gradient(ellipse at center, #0a0e1a 0%, #050810 100%);">
     <div class="grid-overlay"></div>
     <div class="map-container" id="mapContainer">
      <div class="map-content" id="mapContent">
       <svg id="commsSvg" style="position: absolute; top: 0; left: 0; width: 3000px; height: 3000px; pointer-events: none; z-index: 5;"></svg>
       <svg id="zonesSvg" style="position: absolute; top: 0; left: 0; width: 3000px; height: 3000px; pointer-events: none; z-index: 4;"></svg><!-- Celestial bodies and markers populated by JS -->
       <svg id="ordersSvg" style="position: absolute; top: 0; left: 0; width: 3000px; height: 3000px; pointer-events: none; z-index: 6;"></svg>
      </div>
      <div class="selection-marquee" id="selectionMarquee"></div>
     </div><!-- Zoom Controls -->
     <div class="absolute top-4 right-4 zoom-controls"><button class="zoom-btn" id="zoomIn">+</button> <button class="zoom-btn" id="zoomOut">−</button> <button class="zoom-btn" id="zoomReset" style="font-size: 12px;">⟲</button>
     </div><!-- Coordinates Display -->
     <div class="absolute bottom-4 left-4 data-panel text-xs">
      <div class="orbitron mb-1 opacity-70" style="color: var(--accent);">
       // CURSOR POSITION
      </div>
      <div id="cursorCoords">
       X: 0.00 | Y: 0.00 | Z: 0.00
      </div>
     </div><!-- Scale Indicator -->
     <div class="absolute bottom-4 right-4 data-panel text-xs">
      <div class="orbitron mb-1 opacity-70" style="color: var(--accent);">
       // SCALE
      </div>
      <div class="flex items-center gap-2">
       <div style="width: 100px; height: 2px; background: var(--primary);"></div><span id="scaleIndicator">500,000 km</span>
      </div>
     </div>
    </main><!-- Right Sidebar -->
    <aside class="w-72 terminal-frame border-t-0 flex flex-col overflow-hidden">
     <div class="p-3 border-b border-current opacity-50">
      <div class="orbitron text-xs mb-2 opacity-70" style="color: var(--accent);">
       // SELECTED OBJECT
      </div>
      <div id="selectedInfo" class="data-panel">
       <div class="text-center opacity-50 py-4">
        No selection
       </div>
      </div>
     </div>
     <div class="p-3 border-b border-current opacity-50">
      <div class="mb-2 flex items-center justify-between">
       <div class="orbitron text-xs opacity-70" style="color: var(--accent);">
        // RECENT ORDERS
       </div>
       <button class="pager-btn" id="cancelLatestOrder" style="min-width: 58px;">CANCEL</button>
      </div>
      <div id="recentOrders" class="space-y-2 text-xs"><!-- Populated by JS -->
      </div>
      <div class="pager-row">
       <button class="pager-btn" id="ordersPrev">◀</button><span id="ordersPage">1/1</span><button class="pager-btn" id="ordersNext">▶</button>
      </div>
     </div>
     <div class="flex-1 p-3 overflow-hidden">
      <div class="orbitron text-xs mb-2 opacity-70" style="color: var(--accent);">
       // COMMS LOG
      </div>
      <div id="commsLog" class="space-y-1 text-xs"><!-- Populated by JS -->
      </div>
      <div class="pager-row">
       <button class="pager-btn" id="commsPrev">◀</button><span id="commsPage">1/1</span><button class="pager-btn" id="commsNext">▶</button>
      </div>
     </div>
     <div class="p-3 border-t border-current opacity-50">
      <div class="orbitron text-xs mb-2 opacity-70" style="color: var(--accent);">
       // QUICK BROADCAST
      </div>
      <div class="flex gap-2"><input type="text" id="broadcastInput" class="flex-1 bg-transparent border border-current px-2 py-1 text-xs" placeholder="Message..."> <button class="layer-btn" id="broadcastBtn">TX</button>
      </div>
     </div>
    </aside>
   </div><!-- Radial Menu -->
  <div class="radial-menu" id="radialMenu">
   <div class="radial-center" id="radialCenter">
     SELECT<br>
     ACTION
   </div><!-- Options populated dynamically -->
  </div>
  <div class="selection-toast" id="selectionToast"></div>
  </div>
  <div class="crt-overlay crt-flicker"></div>
  <div class="noise-overlay"></div>
  <script>
// Default configuration
const defaultConfig = {
  map_title: 'STANTON TACTICAL OPS',
  fleet_callsign: 'VANGUARD ACTUAL',
  primary_color: '#00ff00',
  secondary_color: '#0a0e1a',
  accent_color: '#ffff00',
  text_color: '#ffffff',
  warning_color: '#ff4444'
};

let config = { ...defaultConfig };

// Map state
const PAGE_SIZE = {
  roster: 6,
  comms: 6,
  orders: 6
};

const ORDER_STATES = {
  ISSUED: 'ISSUED',
  ACKED: 'ACKED',
  CANCELLED: 'CANCELLED'
};

const ACTIVE_ORDER_STATES = new Set([ORDER_STATES.ISSUED, ORDER_STATES.ACKED]);

const mapEntityIndex = new Map();

const mapState = {
  zoom: 1,
  minZoom: 0.3,
  maxZoom: 3,
  panX: 0,
  panY: 0,
  isDragging: false,
  isBoxSelecting: false,
  boxAdditive: false,
  boxStartX: 0,
  boxStartY: 0,
  boxCurrentX: 0,
  boxCurrentY: 0,
  lastX: 0,
  lastY: 0,
  selectedObject: null,
  activeCommandTarget: null,
  pagers: {
    roster: 0,
    comms: 0,
    orders: 0
  },
  orders: [],
  commsLog: [],
  orderSequence: 1,
  layers: {
    celestial: true,
    markers: true,
    units: true,
    comms: false,
    zones: false
  },
  viewMode: 'system'
};

// Stanton System Data
const stantonSystem = {
  star: {
    id: 'stanton',
    name: 'STANTON',
    type: 'star',
    x: 1500,
    y: 1500,
    size: 80
  },
  planets: [
    {
      id: 'crusader',
      name: 'CRUSADER',
      type: 'planet',
      class: 'planet-crusader',
      x: 1500,
      y: 900,
      size: 50,
      orbitRadius: 600,
      moons: [
        { id: 'cellin', name: 'CELLIN', x: 40, y: 0, size: 12 },
        { id: 'daymar', name: 'DAYMAR', x: -50, y: 30, size: 14 },
        { id: 'yela', name: 'YELA', x: 0, y: -55, size: 13 }
      ],
      omMarkers: [
        { id: 'cru-om1', name: 'CRU-OM1', angle: 0 },
        { id: 'cru-om2', name: 'CRU-OM2', angle: 60 },
        { id: 'cru-om3', name: 'CRU-OM3', angle: 120 },
        { id: 'cru-om4', name: 'CRU-OM4', angle: 180 },
        { id: 'cru-om5', name: 'CRU-OM5', angle: 240 },
        { id: 'cru-om6', name: 'CRU-OM6', angle: 300 }
      ]
    },
    {
      id: 'hurston',
      name: 'HURSTON',
      type: 'planet',
      class: 'planet-hurston',
      x: 2100,
      y: 1500,
      size: 55,
      orbitRadius: 600,
      moons: [
        { id: 'aberdeen', name: 'ABERDEEN', x: 50, y: -20, size: 12 },
        { id: 'arial', name: 'ARIAL', x: -40, y: 40, size: 11 },
        { id: 'ita', name: 'ITA', x: 30, y: 50, size: 10 },
        { id: 'magda', name: 'MAGDA', x: -55, y: -15, size: 11 }
      ],
      omMarkers: [
        { id: 'hur-om1', name: 'HUR-OM1', angle: 0 },
        { id: 'hur-om2', name: 'HUR-OM2', angle: 60 },
        { id: 'hur-om3', name: 'HUR-OM3', angle: 120 },
        { id: 'hur-om4', name: 'HUR-OM4', angle: 180 },
        { id: 'hur-om5', name: 'HUR-OM5', angle: 240 },
        { id: 'hur-om6', name: 'HUR-OM6', angle: 300 }
      ]
    },
    {
      id: 'arccorp',
      name: 'ARCCORP',
      type: 'planet',
      class: 'planet-arccorp',
      x: 1500,
      y: 2100,
      size: 48,
      orbitRadius: 600,
      moons: [
        { id: 'lyria', name: 'LYRIA', x: 45, y: 25, size: 11 },
        { id: 'wala', name: 'WALA', x: -40, y: -30, size: 12 }
      ],
      omMarkers: [
        { id: 'arc-om1', name: 'ARC-OM1', angle: 0 },
        { id: 'arc-om2', name: 'ARC-OM2', angle: 60 },
        { id: 'arc-om3', name: 'ARC-OM3', angle: 120 },
        { id: 'arc-om4', name: 'ARC-OM4', angle: 180 },
        { id: 'arc-om5', name: 'ARC-OM5', angle: 240 },
        { id: 'arc-om6', name: 'ARC-OM6', angle: 300 }
      ]
    },
    {
      id: 'microtech',
      name: 'MICROTECH',
      type: 'planet',
      class: 'planet-microtech',
      x: 900,
      y: 1500,
      size: 52,
      orbitRadius: 600,
      moons: [
        { id: 'calliope', name: 'CALLIOPE', x: -50, y: 20, size: 11 },
        { id: 'clio', name: 'CLIO', x: 40, y: -35, size: 12 },
        { id: 'euterpe', name: 'EUTERPE', x: 20, y: 50, size: 10 }
      ],
      omMarkers: [
        { id: 'mic-om1', name: 'MIC-OM1', angle: 0 },
        { id: 'mic-om2', name: 'MIC-OM2', angle: 60 },
        { id: 'mic-om3', name: 'MIC-OM3', angle: 120 },
        { id: 'mic-om4', name: 'MIC-OM4', angle: 180 },
        { id: 'mic-om5', name: 'MIC-OM5', angle: 240 },
        { id: 'mic-om6', name: 'MIC-OM6', angle: 300 }
      ]
    }
  ],
  lagrangePoints: [
    { id: 'cru-l1', name: 'CRU-L1', x: 1500, y: 700, desc: 'Crusader L1' },
    { id: 'cru-l2', name: 'CRU-L2', x: 1500, y: 1100, desc: 'Crusader L2' },
    { id: 'cru-l4', name: 'CRU-L4', x: 1300, y: 750, desc: 'Crusader L4' },
    { id: 'cru-l5', name: 'CRU-L5', x: 1700, y: 750, desc: 'Crusader L5' },
    { id: 'hur-l1', name: 'HUR-L1', x: 2300, y: 1500, desc: 'Hurston L1' },
    { id: 'hur-l2', name: 'HUR-L2', x: 1900, y: 1500, desc: 'Hurston L2' },
    { id: 'hur-l4', name: 'HUR-L4', x: 2200, y: 1300, desc: 'Hurston L4' },
    { id: 'hur-l5', name: 'HUR-L5', x: 2200, y: 1700, desc: 'Hurston L5' },
    { id: 'arc-l1', name: 'ARC-L1', x: 1500, y: 2300, desc: 'ArcCorp L1' },
    { id: 'arc-l2', name: 'ARC-L2', x: 1500, y: 1900, desc: 'ArcCorp L2' },
    { id: 'mic-l1', name: 'MIC-L1', x: 700, y: 1500, desc: 'microTech L1' },
    { id: 'mic-l2', name: 'MIC-L2', x: 1100, y: 1500, desc: 'microTech L2' }
  ],
  jumpPoints: [
    { id: 'jp-pyro', name: 'PYRO GATE', x: 2600, y: 800, dest: 'Pyro System' },
    { id: 'jp-terra', name: 'TERRA GATE', x: 400, y: 2200, dest: 'Terra System' }
  ]
};

// Fleet units data
const fleetUnits = [
  { id: 'alpha-1', callsign: 'ALPHA-1', type: 'friendly', wing: 'ALPHA', squad: 'A1', role: 'Command', ship: 'Carrack', x: 1450, y: 920, status: 'online' },
  { id: 'alpha-2', callsign: 'ALPHA-2', type: 'friendly', wing: 'ALPHA', squad: 'A1', role: 'Fighter', ship: 'Gladius', x: 1420, y: 890, status: 'online' },
  { id: 'alpha-3', callsign: 'ALPHA-3', type: 'friendly', wing: 'ALPHA', squad: 'A2', role: 'Fighter', ship: 'Arrow', x: 1480, y: 895, status: 'combat' },
  { id: 'bravo-1', callsign: 'BRAVO-1', type: 'friendly', wing: 'BRAVO', squad: 'B1', role: 'Support', ship: 'Hammerhead', x: 2080, y: 1520, status: 'online' },
  { id: 'bravo-2', callsign: 'BRAVO-2', type: 'friendly', wing: 'BRAVO', squad: 'B1', role: 'Fighter', ship: 'Sabre', x: 2060, y: 1480, status: 'online' },
  { id: 'hostile-1', callsign: 'TANGO-1', type: 'hostile', wing: 'HOSTILE', role: 'Unknown', ship: 'Cutlass', x: 1530, y: 880, status: 'combat' },
  { id: 'hostile-2', callsign: 'TANGO-2', type: 'hostile', wing: 'HOSTILE', role: 'Unknown', ship: 'Buccaneer', x: 1560, y: 910, status: 'combat' },
  { id: 'neutral-1', callsign: 'TRADER-7', type: 'neutral', wing: 'CIVIL', role: 'Cargo', ship: 'Caterpillar', x: 1520, y: 2080, status: 'online' }
];

const fleetUnitsById = new Map(fleetUnits.map((unit) => [unit.id, unit]));

// Seed comms log entries
const seedCommsLogEntries = [
  { createdAt: new Date(Date.now() - 30 * 1000).toISOString(), sender: 'ALPHA-1', msg: 'Contact bearing 045, two hostiles' },
  { createdAt: new Date(Date.now() - 58 * 1000).toISOString(), sender: 'BRAVO-1', msg: 'Station secure, awaiting orders' },
  { createdAt: new Date(Date.now() - 86 * 1000).toISOString(), sender: 'COMMAND', msg: 'All units maintain position' },
  { createdAt: new Date(Date.now() - 114 * 1000).toISOString(), sender: 'ALPHA-3', msg: 'Engaging hostile, request backup' },
  { createdAt: new Date(Date.now() - 142 * 1000).toISOString(), sender: 'RECON-2', msg: 'Jump point clear, no activity' }
];

// Seed orders
const seedOrders = [
  {
    id: 'ord-seed-1',
    createdAt: new Date(Date.now() - 3 * 60 * 1000).toISOString(),
    issuer: 'COMMAND',
    selectionUnitIds: ['alpha-1', 'alpha-2'],
    selectionLabel: 'ALPHA WING',
    verb: 'ENGAGE',
    target: { type: 'unit', id: 'hostile-1', name: 'TANGO-1', x: 1530, y: 880 },
    params: {},
    state: 'ISSUED'
  },
  {
    id: 'ord-seed-2',
    createdAt: new Date(Date.now() - 5 * 60 * 1000).toISOString(),
    issuer: 'COMMAND',
    selectionUnitIds: ['bravo-1'],
    selectionLabel: 'BRAVO-1',
    verb: 'HOLD',
    target: { type: 'coordinates', id: 'coord-2080-1520', name: 'GRID 2080,1520', x: 2080, y: 1520 },
    params: {},
    state: 'ISSUED'
  },
  {
    id: 'ord-seed-3',
    createdAt: new Date(Date.now() - 7 * 60 * 1000).toISOString(),
    issuer: 'COMMAND',
    selectionUnitIds: ['alpha-1', 'alpha-2', 'alpha-3', 'bravo-1', 'bravo-2'],
    selectionLabel: 'TASK FORCE',
    verb: 'ROE',
    target: { type: 'jump-point', id: 'jp-pyro', name: 'PYRO GATE', x: 2600, y: 800 },
    params: { profile: 'WEAPONS FREE' },
    state: 'ISSUED'
  }
];

// DOM Elements
const mapContainer = document.getElementById('mapContainer');
const mapContent = document.getElementById('mapContent');
const radialMenu = document.getElementById('radialMenu');
const radialCenter = document.getElementById('radialCenter');
const selectionMarquee = document.getElementById('selectionMarquee');
const selectionToast = document.getElementById('selectionToast');

let toastTimeout = null;
let selectionManager = null;

function registerMapEntity(entity, element) {
  const entityId = `${entity.type}:${entity.id}`;
  mapEntityIndex.set(entityId, entity);
  element.dataset.entityId = entityId;
}

class SelectionManager {
  constructor(units) {
    this.units = units.filter((unit) => unit.type === 'friendly');
    this.unitIds = new Set(this.units.map((unit) => unit.id));
    this.selectedIds = new Set();
    this.controlGroups = {};
    this.filters = {
      wing: 'ALL',
      role: 'ALL',
      status: 'ALL'
    };
    this.filterOptions = {
      wing: ['ALL', ...new Set(this.units.map((unit) => unit.wing))],
      role: ['ALL', ...new Set(this.units.map((unit) => unit.role))],
      status: ['ALL', ...new Set(this.units.map((unit) => unit.status))]
    };
  }

  getSelectedIds() {
    return Array.from(this.selectedIds);
  }

  getSelectedUnits() {
    return this.getSelectedIds().map((id) => fleetUnitsById.get(id)).filter(Boolean);
  }

  setSelection(ids, mode = 'replace') {
    const normalizedIds = ids.filter((id) => this.unitIds.has(id));
    if (mode === 'append') {
      normalizedIds.forEach((id) => this.selectedIds.add(id));
    } else {
      this.selectedIds = new Set(normalizedIds);
    }
    syncSelectionState();
  }

  selectSingle(id) {
    if (!this.unitIds.has(id)) {
      return;
    }
    this.selectedIds = new Set([id]);
    syncSelectionState();
  }

  toggle(id) {
    if (!this.unitIds.has(id)) {
      return;
    }
    if (this.selectedIds.has(id)) {
      this.selectedIds.delete(id);
    } else {
      this.selectedIds.add(id);
    }
    syncSelectionState();
  }

  clear() {
    if (this.selectedIds.size === 0) {
      return;
    }
    this.selectedIds.clear();
    syncSelectionState();
  }

  getSelectionLabel() {
    const units = this.getSelectedUnits();
    if (units.length === 0) {
      return 'NONE';
    }
    if (units.length <= 2) {
      return units.map((unit) => unit.callsign).join(', ');
    }
    return `${units[0].callsign}, ${units[1].callsign} +${units.length - 2}`;
  }

  assignGroup(slot) {
    if (this.selectedIds.size === 0) {
      showSelectionToast(`GROUP ${slot}: EMPTY`);
      return;
    }
    this.controlGroups[slot] = this.getSelectedIds();
    showSelectionToast(`GROUP ${slot}: ${this.getSelectionLabel()}`);
  }

  recallGroup(slot) {
    const group = this.controlGroups[slot];
    if (!group || group.length === 0) {
      showSelectionToast(`GROUP ${slot}: EMPTY`);
      return;
    }
    this.setSelection(group);
    centerOnSelectionBounds(this.getSelectedUnits());
    showSelectionToast(`GROUP ${slot}: ${this.getSelectionLabel()}`);
  }

  cycleFilter(filterKey) {
    const options = this.filterOptions[filterKey];
    const currentIndex = options.indexOf(this.filters[filterKey]);
    const nextIndex = (currentIndex + 1) % options.length;
    this.filters[filterKey] = options[nextIndex];
    updateSelectByChips();
    this.applyActiveFilter();
  }

  applyActiveFilter() {
    const filteredIds = this.units
      .filter((unit) =>
        (this.filters.wing === 'ALL' || unit.wing === this.filters.wing) &&
        (this.filters.role === 'ALL' || unit.role === this.filters.role) &&
        (this.filters.status === 'ALL' || unit.status === this.filters.status)
      )
      .map((unit) => unit.id);
    this.setSelection(filteredIds);
    showSelectionToast(`SELECT ${this.getSelectionLabel()}`);
  }
}

function getVerbCode(verb) {
  const table = {
    MOVE: 'MOV',
    HOLD: 'HLD',
    PATROL: 'PAT',
    ESCORT: 'ESC',
    ENGAGE: 'ENG',
    ROE: 'ROE',
    MARK: 'MRK',
    PING: 'PNG',
    DRAW_ZONE: 'DRW',
    INFO: 'INF',
    SCAN: 'SCN'
  };
  return table[verb] || String(verb || 'CMD').slice(0, 3).toUpperCase();
}

function getLatestOrderForUnit(unitId) {
  return mapState.orders.find((order) =>
    ACTIVE_ORDER_STATES.has(order.state) &&
    Array.isArray(order.selectionUnitIds) &&
    order.selectionUnitIds.includes(unitId)
  ) || null;
}

function getLatestPendingOrderForUnit(unitId) {
  return mapState.orders.find((order) =>
    order.state === ORDER_STATES.ISSUED &&
    Array.isArray(order.selectionUnitIds) &&
    order.selectionUnitIds.includes(unitId)
  ) || null;
}

function getOrderSummary(order) {
  return `${order.verb} ${order.selectionLabel} → ${order.target?.name || 'TARGET'}`;
}

function isOrderActive(order) {
  return ACTIVE_ORDER_STATES.has(order.state);
}

function getOrderTargetPoint(order) {
  if (!order || !order.target) {
    return null;
  }
  if (order.target.type === 'unit' && order.target.id) {
    const targetUnit = fleetUnitsById.get(order.target.id);
    if (targetUnit) {
      return { x: targetUnit.x, y: targetUnit.y, name: targetUnit.callsign };
    }
  }
  if (typeof order.target.x === 'number' && typeof order.target.y === 'number') {
    return { x: order.target.x, y: order.target.y, name: order.target.name };
  }
  return null;
}

function refreshOrderPresentation() {
  renderOrdersOverlay();
  renderUnitOrderBadges();
  renderRecentOrders();
  renderFleetRoster();
}

// Initialize map
function initMap() {
  mapState.commsLog = [...seedCommsLogEntries];
  mapState.orders = [...seedOrders];
  mapState.orderSequence = mapState.orders.length + 1;
  selectionManager = new SelectionManager(fleetUnits);
  renderCelestialBodies();
  renderLagrangePoints();
  renderJumpPoints();
  renderUnits();
  updateSelectByChips();
  syncSelectionState();
  renderCommsLog();
  refreshOrderPresentation();
  renderMinimap();
  updateMapTransform();
  setupEventListeners();
  startClock();
}

// Render celestial bodies
function renderCelestialBodies() {
  const container = document.getElementById('mapContent');
  
  // Star
  const star = stantonSystem.star;
  const starEl = document.createElement('div');
  starEl.className = 'celestial-body star';
  starEl.style.cssText = `left: ${star.x}px; top: ${star.y}px; width: ${star.size}px; height: ${star.size}px;`;
  starEl.dataset.name = star.name;
  starEl.dataset.id = star.id;
  starEl.dataset.type = 'star';
  starEl.onclick = (e) => handleObjectClick(e, star);
  registerMapEntity(star, starEl);
  container.appendChild(starEl);
  
  // Planets and their elements
  stantonSystem.planets.forEach(planet => {
    // Orbit ring
    const orbitDist = Math.sqrt(Math.pow(planet.x - star.x, 2) + Math.pow(planet.y - star.y, 2));
    const orbitEl = document.createElement('div');
    orbitEl.className = 'orbit-ring';
    orbitEl.style.cssText = `left: ${star.x}px; top: ${star.y}px; width: ${orbitDist * 2}px; height: ${orbitDist * 2}px;`;
    container.appendChild(orbitEl);
    
    // Planet
    const planetEl = document.createElement('div');
    planetEl.className = `celestial-body ${planet.class}`;
    planetEl.style.cssText = `left: ${planet.x}px; top: ${planet.y}px; width: ${planet.size}px; height: ${planet.size}px;`;
    planetEl.dataset.name = planet.name;
    planetEl.dataset.id = planet.id;
    planetEl.dataset.type = 'planet';
    planetEl.onclick = (e) => handleObjectClick(e, planet);
    registerMapEntity(planet, planetEl);
    container.appendChild(planetEl);
    
    // Moons
    planet.moons.forEach(moon => {
      const moonEl = document.createElement('div');
      moonEl.className = 'celestial-body moon';
      moonEl.style.cssText = `left: ${planet.x + moon.x}px; top: ${planet.y + moon.y}px; width: ${moon.size}px; height: ${moon.size}px;`;
      moonEl.dataset.name = moon.name;
      moonEl.dataset.id = moon.id;
      moonEl.dataset.type = 'moon';
      moonEl.dataset.parent = planet.name;
      const moonEntity = { ...moon, parent: planet.name, type: 'moon', x: planet.x + moon.x, y: planet.y + moon.y };
      moonEl.onclick = (e) => handleObjectClick(e, moonEntity);
      registerMapEntity(moonEntity, moonEl);
      container.appendChild(moonEl);
    });
    
    // OM Markers
    planet.omMarkers.forEach(om => {
      const omRadius = planet.size + 35;
      const angleRad = (om.angle * Math.PI) / 180;
      const omX = planet.x + omRadius * Math.cos(angleRad);
      const omY = planet.y + omRadius * Math.sin(angleRad);
      
      const omEl = document.createElement('div');
      omEl.className = 'om-marker';
      omEl.style.cssText = `left: ${omX}px; top: ${omY}px;`;
      omEl.dataset.name = om.name;
      omEl.dataset.id = om.id;
      omEl.dataset.type = 'om-marker';
      omEl.dataset.parent = planet.name;
      const omEntity = { ...om, x: omX, y: omY, parent: planet.name, type: 'om-marker' };
      omEl.onclick = (e) => handleObjectClick(e, omEntity);
      registerMapEntity(omEntity, omEl);
      container.appendChild(omEl);
    });
  });
}

// Render Lagrange points
function renderLagrangePoints() {
  const container = document.getElementById('mapContent');
  
  stantonSystem.lagrangePoints.forEach(lp => {
    const lpEl = document.createElement('div');
    lpEl.className = 'lagrange-point';
    lpEl.style.cssText = `left: ${lp.x}px; top: ${lp.y}px;`;
    lpEl.dataset.name = lp.name;
    lpEl.dataset.id = lp.id;
    lpEl.dataset.type = 'lagrange';
    lpEl.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 2L2 12l10 10 10-10L12 2zm0 4l6 6-6 6-6-6 6-6z"/></svg>`;
    const lagrangeEntity = { ...lp, type: 'lagrange' };
    lpEl.onclick = (e) => handleObjectClick(e, lagrangeEntity);
    registerMapEntity(lagrangeEntity, lpEl);
    container.appendChild(lpEl);
  });
}

// Render jump points
function renderJumpPoints() {
  const container = document.getElementById('mapContent');
  
  stantonSystem.jumpPoints.forEach(jp => {
    const jpEl = document.createElement('div');
    jpEl.className = 'jump-point';
    jpEl.style.cssText = `left: ${jp.x}px; top: ${jp.y}px;`;
    jpEl.dataset.name = jp.name;
    jpEl.dataset.id = jp.id;
    jpEl.dataset.type = 'jump-point';
    jpEl.innerHTML = `<div style="width: 10px; height: 10px; background: var(--warning); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>`;
    const jumpEntity = { ...jp, type: 'jump-point' };
    jpEl.onclick = (e) => handleObjectClick(e, jumpEntity);
    registerMapEntity(jumpEntity, jpEl);
    container.appendChild(jpEl);
  });
}

// Render units
function renderUnits() {
  const container = document.getElementById('mapContent');
  
  fleetUnits.forEach(unit => {
    const unitEl = document.createElement('div');
    unitEl.className = 'unit-marker';
    unitEl.style.cssText = `left: ${unit.x}px; top: ${unit.y}px; color: ${unit.type === 'friendly' ? 'var(--primary)' : unit.type === 'hostile' ? 'var(--danger)' : 'var(--accent)'};`;
    unitEl.dataset.callsign = unit.callsign;
    unitEl.dataset.id = unit.id;
    unitEl.dataset.unitId = unit.id;
    unitEl.dataset.type = 'unit';
    unitEl.dataset.unitType = unit.type;
    unitEl.innerHTML = `<div class="unit-icon unit-${unit.type}">${unit.callsign.charAt(0)}</div>`;
    const unitEntity = { ...unit, type: 'unit', unitType: unit.type };
    unitEl.onclick = (e) => handleUnitSelectionClick(e, unit);
    registerMapEntity(unitEntity, unitEl);
    container.appendChild(unitEl);
  });
}

function createSvgElement(name, attrs = {}) {
  const node = document.createElementNS('http://www.w3.org/2000/svg', name);
  Object.entries(attrs).forEach(([key, value]) => node.setAttribute(key, String(value)));
  return node;
}

function renderOrdersOverlay() {
  const svg = document.getElementById('ordersSvg');
  if (!svg) {
    return;
  }
  svg.innerHTML = '';

  const defs = createSvgElement('defs');
  const arrowMarker = createSvgElement('marker', {
    id: 'ordersArrow',
    markerWidth: 8,
    markerHeight: 8,
    refX: 7,
    refY: 4,
    orient: 'auto'
  });
  arrowMarker.appendChild(createSvgElement('path', { d: 'M0,0 L8,4 L0,8 Z', fill: '#ffff00' }));
  defs.appendChild(arrowMarker);

  const chevronMarker = createSvgElement('marker', {
    id: 'ordersChevron',
    markerWidth: 10,
    markerHeight: 10,
    refX: 8,
    refY: 5,
    orient: 'auto'
  });
  chevronMarker.appendChild(createSvgElement('path', { d: 'M1,1 L9,5 L1,9 L3,5 Z', fill: '#ff4444' }));
  defs.appendChild(chevronMarker);
  svg.appendChild(defs);

  mapState.orders.filter((order) => isOrderActive(order)).forEach((order) => {
    const targetPoint = getOrderTargetPoint(order);
    if (!targetPoint) {
      return;
    }

    const isAcked = order.state === ORDER_STATES.ACKED;
    const intentColor = isAcked ? 'var(--primary)' : 'var(--accent)';
    const intentOpacity = isAcked ? 0.75 : 1;

    const drawTargetLabel = () => {
      const labelText = `${getVerbCode(order.verb)}${isAcked ? '' : '?'}`;
      const labelGroup = createSvgElement('g', { opacity: intentOpacity });
      labelGroup.appendChild(createSvgElement('rect', {
        x: targetPoint.x + 10,
        y: targetPoint.y - 20,
        width: 28,
        height: 14,
        fill: 'rgba(10,14,26,0.9)',
        stroke: intentColor,
        'stroke-width': 1
      }));
      labelGroup.appendChild(createSvgElement('text', {
        x: targetPoint.x + 24,
        y: targetPoint.y - 10,
        'text-anchor': 'middle',
        fill: intentColor,
        'font-family': 'Share Tech Mono',
        'font-size': 8
      }));
      labelGroup.lastChild.textContent = labelText;
      svg.appendChild(labelGroup);
    };

    if (!Array.isArray(order.selectionUnitIds) || order.selectionUnitIds.length === 0) {
      svg.appendChild(createSvgElement('circle', {
        cx: targetPoint.x,
        cy: targetPoint.y,
        r: 10,
        fill: 'none',
        stroke: intentColor,
        'stroke-width': 1.2,
        opacity: intentOpacity
      }));
      drawTargetLabel();
      return;
    }

    order.selectionUnitIds.forEach((unitId) => {
      const source = fleetUnitsById.get(unitId);
      if (!source) {
        return;
      }

      if (order.verb === 'HOLD') {
        svg.appendChild(createSvgElement('circle', {
          cx: source.x,
          cy: source.y,
          r: 16,
          fill: 'none',
          stroke: intentColor,
          'stroke-width': 1.4,
          opacity: intentOpacity
        }));
        return;
      }

      if (order.verb === 'PATROL') {
        svg.appendChild(createSvgElement('line', {
          x1: source.x,
          y1: source.y,
          x2: targetPoint.x,
          y2: targetPoint.y,
          stroke: intentColor,
          'stroke-width': 1.2,
          'stroke-dasharray': '5 4',
          opacity: intentOpacity
        }));
        svg.appendChild(createSvgElement('circle', {
          cx: targetPoint.x,
          cy: targetPoint.y,
          r: 26,
          fill: 'none',
          stroke: intentColor,
          'stroke-width': 1.2,
          'stroke-dasharray': '6 4',
          opacity: intentOpacity
        }));
        return;
      }

      if (order.verb === 'ENGAGE') {
        svg.appendChild(createSvgElement('line', {
          x1: source.x,
          y1: source.y,
          x2: targetPoint.x,
          y2: targetPoint.y,
          stroke: 'var(--danger)',
          'stroke-width': 2.4,
          'marker-end': 'url(#ordersChevron)',
          opacity: intentOpacity
        }));
        return;
      }

      if (order.verb === 'ESCORT') {
        svg.appendChild(createSvgElement('line', {
          x1: source.x,
          y1: source.y,
          x2: targetPoint.x,
          y2: targetPoint.y,
          stroke: 'var(--primary)',
          'stroke-width': 1.6,
          opacity: intentOpacity
        }));
        return;
      }

      svg.appendChild(createSvgElement('line', {
        x1: source.x,
        y1: source.y,
        x2: targetPoint.x,
        y2: targetPoint.y,
        stroke: intentColor,
        'stroke-width': 1.6,
        'marker-end': 'url(#ordersArrow)',
        opacity: intentOpacity
      }));
    });

    if (order.verb === 'ESCORT') {
      svg.appendChild(createSvgElement('polygon', {
        points: `${targetPoint.x},${targetPoint.y - 9} ${targetPoint.x + 7},${targetPoint.y - 4} ${targetPoint.x + 5},${targetPoint.y + 8} ${targetPoint.x - 5},${targetPoint.y + 8} ${targetPoint.x - 7},${targetPoint.y - 4}`,
        fill: 'rgba(0,255,0,0.18)',
        stroke: 'var(--primary)',
        'stroke-width': 1.1,
        opacity: intentOpacity
      }));
    }

    drawTargetLabel();
  });
}

function renderUnitOrderBadges() {
  document.querySelectorAll('.unit-marker[data-unit-id]').forEach((marker) => {
    marker.querySelectorAll('.unit-order-badge').forEach((badge) => badge.remove());
    const unitId = marker.dataset.unitId;
    const order = getLatestOrderForUnit(unitId);
    if (!order) {
      return;
    }
    const badge = document.createElement('button');
    badge.type = 'button';
    badge.className = `unit-order-badge ${order.state === ORDER_STATES.ISSUED ? 'pending' : 'acked'}`;
    badge.textContent = `${getVerbCode(order.verb)}${order.state === ORDER_STATES.ISSUED ? '?' : ''}`;
    if (order.state === ORDER_STATES.ISSUED) {
      badge.title = 'Acknowledge order';
      badge.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        acknowledgeOrderForUnit(unitId);
      });
    } else {
      badge.disabled = true;
    }
    marker.appendChild(badge);
  });
}

// Render fleet roster
function renderFleetRoster() {
  const roster = document.getElementById('fleetRoster');
  roster.innerHTML = '';

  const friendlyUnits = fleetUnits.filter((unit) => unit.type === 'friendly');
  const pageCount = Math.max(1, Math.ceil(friendlyUnits.length / PAGE_SIZE.roster));
  mapState.pagers.roster = Math.min(mapState.pagers.roster, pageCount - 1);
  const pageStart = mapState.pagers.roster * PAGE_SIZE.roster;
  const pageUnits = friendlyUnits.slice(pageStart, pageStart + PAGE_SIZE.roster);

  pageUnits.forEach((unit) => {
    const unitEl = document.createElement('div');
    const isSelected = selectionManager && selectionManager.selectedIds.has(unit.id);
    const lastOrder = getLatestOrderForUnit(unit.id);
    const awaitingAck = lastOrder && lastOrder.state === ORDER_STATES.ISSUED;
    unitEl.className = `flex items-center gap-2 p-2 border border-current cursor-pointer transition-opacity ${isSelected ? 'opacity-100' : 'opacity-50 hover:opacity-100'}`;
    unitEl.dataset.unitId = unit.id;
    unitEl.innerHTML = `
      <span class="status-dot status-${unit.status}"></span>
      <div class="flex-1">
        <div class="font-bold" style="color: var(--primary);">${unit.callsign}</div>
        <div class="opacity-60">${unit.ship} • ${unit.role} • ${unit.wing}</div>
      </div>
      ${lastOrder ? `<div class="text-[9px] px-1 py-[1px] border border-current opacity-75">${getVerbCode(lastOrder.verb)}${awaitingAck ? '?' : ''}</div>` : ''}
      ${lastOrder ? `<div class="text-[9px] px-1 py-[1px] border border-current opacity-75 ${awaitingAck ? '' : 'text-green-200'}">${awaitingAck ? 'ACK?' : 'ACK'}</div>` : ''}
      ${awaitingAck ? `<button class="pager-btn" data-ack-unit="${unit.id}" style="min-width:32px;height:18px;">ACK</button>` : ''}
    `;
    if (isSelected) {
      unitEl.style.borderColor = 'var(--accent)';
    }
    const ackButton = unitEl.querySelector('[data-ack-unit]');
    if (ackButton) {
      ackButton.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        acknowledgeOrderForUnit(unit.id);
      });
    }
    unitEl.onclick = (e) => {
      const unitEntity = { ...unit, type: 'unit', unitType: unit.type };
      handleUnitSelectionClick(e, unit);
      mapState.selectedObject = unitEntity;
      updateSelectedInfo(unitEntity);
      centerOnSelectionBounds(selectionManager.getSelectedUnits());
    };
    roster.appendChild(unitEl);
  });

  updatePagerControls('fleetRosterPage', 'fleetRosterPrev', 'fleetRosterNext', mapState.pagers.roster, pageCount);
}

// Render comms log
function renderCommsLog() {
  const log = document.getElementById('commsLog');
  log.innerHTML = '';

  const pageCount = Math.max(1, Math.ceil(mapState.commsLog.length / PAGE_SIZE.comms));
  mapState.pagers.comms = Math.min(mapState.pagers.comms, pageCount - 1);
  const pageStart = mapState.pagers.comms * PAGE_SIZE.comms;
  const pageEntries = mapState.commsLog.slice(pageStart, pageStart + PAGE_SIZE.comms);

  pageEntries.forEach((entry) => {
    const entryEl = document.createElement('div');
    entryEl.className = 'p-1 border-l-2 pl-2 mb-1';
    entryEl.style.borderColor = entry.sender === 'COMMAND' ? 'var(--accent)' : 'var(--primary)';
    entryEl.innerHTML = `
      <div class="opacity-50">${formatClock(entry.createdAt, true)}</div>
      <div><span style="color: ${entry.sender === 'COMMAND' ? 'var(--accent)' : 'var(--primary)'};">${entry.sender}:</span> ${entry.msg}</div>
    `;
    log.appendChild(entryEl);
  });

  updatePagerControls('commsPage', 'commsPrev', 'commsNext', mapState.pagers.comms, pageCount);
}

// Render recent orders
function renderRecentOrders() {
  const orders = document.getElementById('recentOrders');
  orders.innerHTML = '';

  const pageCount = Math.max(1, Math.ceil(mapState.orders.length / PAGE_SIZE.orders));
  mapState.pagers.orders = Math.min(mapState.pagers.orders, pageCount - 1);
  const pageStart = mapState.pagers.orders * PAGE_SIZE.orders;
  const pageEntries = mapState.orders.slice(pageStart, pageStart + PAGE_SIZE.orders);

  pageEntries.forEach((order) => {
    const orderEl = document.createElement('div');
    orderEl.className = 'p-2 border border-current opacity-50';
    const isCancelled = order.state === ORDER_STATES.CANCELLED;
    const isAcked = order.state === ORDER_STATES.ACKED;
    orderEl.style.borderColor = isCancelled ? 'var(--warning)' : (isAcked ? 'var(--primary)' : 'var(--accent)');
    orderEl.innerHTML = `
      <div class="flex justify-between">
        <span style="color: ${isCancelled ? 'var(--warning)' : (isAcked ? 'var(--primary)' : 'var(--accent)')};">${order.verb}</span>
        <span class="opacity-50">${formatClock(order.createdAt, false)}</span>
      </div>
      <div class="opacity-60">${order.selectionLabel} → ${order.target.name}</div>
      <div class="opacity-50">${order.state}${order.ackBy ? ` • ${order.ackBy}` : ''}</div>
    `;
    orders.appendChild(orderEl);
  });

  updatePagerControls('ordersPage', 'ordersPrev', 'ordersNext', mapState.pagers.orders, pageCount);
  const cancelButton = document.getElementById('cancelLatestOrder');
  if (cancelButton) {
    cancelButton.disabled = !(mapState.orders[0] && mapState.orders[0].state !== ORDER_STATES.CANCELLED);
  }
}

// Render minimap
function renderMinimap() {
  const minimap = document.getElementById('minimap');
  const scale = 150 / 3000;
  
  // Star
  const starDot = document.createElement('div');
  starDot.className = 'minimap-dot';
  starDot.style.cssText = `left: ${stantonSystem.star.x * scale}px; top: ${stantonSystem.star.y * scale}px; background: #ffff00; width: 6px; height: 6px; box-shadow: 0 0 8px #ffff00;`;
  minimap.appendChild(starDot);
  
  // Planets
  stantonSystem.planets.forEach(planet => {
    const dot = document.createElement('div');
    dot.className = 'minimap-dot';
    dot.style.cssText = `left: ${planet.x * scale}px; top: ${planet.y * scale}px; background: var(--primary);`;
    minimap.appendChild(dot);
  });
  
  // Units
  fleetUnits.forEach(unit => {
    const dot = document.createElement('div');
    dot.className = 'minimap-dot';
    const color = unit.type === 'friendly' ? 'var(--primary)' : unit.type === 'hostile' ? 'var(--danger)' : 'var(--accent)';
    dot.style.cssText = `left: ${unit.x * scale}px; top: ${unit.y * scale}px; background: ${color}; width: 3px; height: 3px;`;
    minimap.appendChild(dot);
  });
}

// Update minimap viewport
function updateMinimapViewport() {
  const viewport = document.getElementById('minimapViewport');
  const containerRect = mapContainer.getBoundingClientRect();
  const scale = 150 / 3000;
  
  const viewWidth = (containerRect.width / mapState.zoom) * scale;
  const viewHeight = (containerRect.height / mapState.zoom) * scale;
  const viewX = ((-mapState.panX / mapState.zoom) + containerRect.width / 2 / mapState.zoom) * scale - viewWidth / 2;
  const viewY = ((-mapState.panY / mapState.zoom) + containerRect.height / 2 / mapState.zoom) * scale - viewHeight / 2;
  
  viewport.style.cssText = `left: ${viewX}px; top: ${viewY}px; width: ${viewWidth}px; height: ${viewHeight}px;`;
}

// Handle object click
function handleObjectClick(e, obj) {
  e.stopPropagation();
  hideRadialMenu();
  selectionManager.clear();
  mapState.selectedObject = obj;
  updateSelectedInfo(obj);
}

function handleUnitSelectionClick(e, unit) {
  e.stopPropagation();
  hideRadialMenu();
  if (unit.type !== 'friendly') {
    mapState.selectedObject = { ...unit, type: 'unit', unitType: unit.type };
    updateSelectedInfo(mapState.selectedObject);
    return;
  }

  if (e.shiftKey) {
    selectionManager.toggle(unit.id);
  } else {
    selectionManager.selectSingle(unit.id);
  }
  mapState.selectedObject = { ...unit, type: 'unit', unitType: unit.type };
  updateSelectedInfo(mapState.selectedObject);
}

// Update selected info panel
function updateSelectedInfo(obj) {
  const info = document.getElementById('selectedInfo');
  let content = '';

  if (!obj) {
    info.innerHTML = '<div class="text-center opacity-50 py-4">No selection</div>';
    return;
  }
  
  if (obj.type === 'star') {
    content = `
      <div class="data-row"><span class="data-label">TYPE</span><span class="data-value">G-TYPE STAR</span></div>
      <div class="data-row"><span class="data-label">NAME</span><span class="data-value">${obj.name}</span></div>
      <div class="data-row"><span class="data-label">STATUS</span><span class="data-value" style="color: var(--primary);">STABLE</span></div>
    `;
  } else if (obj.type === 'planet') {
    content = `
      <div class="data-row"><span class="data-label">TYPE</span><span class="data-value">PLANET</span></div>
      <div class="data-row"><span class="data-label">NAME</span><span class="data-value">${obj.name}</span></div>
      <div class="data-row"><span class="data-label">MOONS</span><span class="data-value">${obj.moons?.length || 0}</span></div>
      <div class="data-row"><span class="data-label">THREAT</span><span class="data-value" style="color: var(--warning);">MODERATE</span></div>
    `;
  } else if (obj.type === 'moon') {
    content = `
      <div class="data-row"><span class="data-label">TYPE</span><span class="data-value">MOON</span></div>
      <div class="data-row"><span class="data-label">NAME</span><span class="data-value">${obj.name}</span></div>
      <div class="data-row"><span class="data-label">PARENT</span><span class="data-value">${obj.parent}</span></div>
    `;
  } else if (obj.type === 'om-marker') {
    content = `
      <div class="data-row"><span class="data-label">TYPE</span><span class="data-value">OM MARKER</span></div>
      <div class="data-row"><span class="data-label">ID</span><span class="data-value">${obj.name}</span></div>
      <div class="data-row"><span class="data-label">BODY</span><span class="data-value">${obj.parent}</span></div>
    `;
  } else if (obj.type === 'lagrange') {
    content = `
      <div class="data-row"><span class="data-label">TYPE</span><span class="data-value">LAGRANGE PT</span></div>
      <div class="data-row"><span class="data-label">ID</span><span class="data-value">${obj.name}</span></div>
      <div class="data-row"><span class="data-label">DESC</span><span class="data-value">${obj.desc}</span></div>
    `;
  } else if (obj.type === 'jump-point') {
    content = `
      <div class="data-row"><span class="data-label">TYPE</span><span class="data-value">JUMP POINT</span></div>
      <div class="data-row"><span class="data-label">NAME</span><span class="data-value">${obj.name}</span></div>
      <div class="data-row"><span class="data-label">DEST</span><span class="data-value" style="color: var(--accent);">${obj.dest}</span></div>
    `;
  } else if (obj.type === 'unit') {
    const affiliation = (obj.unitType || obj.affiliation || 'friendly').toUpperCase();
    const statusColor = obj.status === 'online' ? 'var(--primary)' : obj.status === 'combat' ? 'var(--danger)' : '#555';
    content = `
      <div class="data-row"><span class="data-label">CALLSIGN</span><span class="data-value">${obj.callsign}</span></div>
      <div class="data-row"><span class="data-label">SHIP</span><span class="data-value">${obj.ship}</span></div>
      <div class="data-row"><span class="data-label">WING</span><span class="data-value">${obj.wing || 'N/A'}</span></div>
      <div class="data-row"><span class="data-label">ROLE</span><span class="data-value">${obj.role}</span></div>
      <div class="data-row"><span class="data-label">STATUS</span><span class="data-value" style="color: ${statusColor};">${obj.status.toUpperCase()}</span></div>
      <div class="data-row"><span class="data-label">AFFIL</span><span class="data-value">${affiliation}</span></div>
    `;
  } else if (obj.type === 'coordinates') {
    content = `
      <div class="data-row"><span class="data-label">TYPE</span><span class="data-value">GRID COORD</span></div>
      <div class="data-row"><span class="data-label">NAME</span><span class="data-value">${obj.name}</span></div>
      <div class="data-row"><span class="data-label">X</span><span class="data-value">${Math.round(obj.x)}</span></div>
      <div class="data-row"><span class="data-label">Y</span><span class="data-value">${Math.round(obj.y)}</span></div>
    `;
  }
  
  info.innerHTML = content || '<div class="text-center opacity-50 py-4">No selection</div>';
}

function formatClock(timestamp, withSeconds) {
  const date = new Date(timestamp);
  if (Number.isNaN(date.getTime())) {
    return '--:--';
  }
  return date.toLocaleTimeString('en-US', {
    hour12: false,
    hour: '2-digit',
    minute: '2-digit',
    ...(withSeconds ? { second: '2-digit' } : {})
  });
}

function updatePagerControls(labelId, prevId, nextId, pageIndex, pageCount) {
  const label = document.getElementById(labelId);
  const prev = document.getElementById(prevId);
  const next = document.getElementById(nextId);
  if (!label || !prev || !next) {
    return;
  }
  label.textContent = `${pageIndex + 1}/${pageCount}`;
  prev.disabled = pageIndex === 0;
  next.disabled = pageIndex >= pageCount - 1;
}

function updateSelectByChips() {
  document.querySelectorAll('[data-select-by]').forEach((chip) => {
    const key = chip.dataset.selectBy;
    const value = selectionManager.filters[key];
    chip.textContent = `${key.toUpperCase()}: ${value === 'ALL' ? 'ALL' : String(value).toUpperCase()}`;
    chip.classList.toggle('active', value !== 'ALL');
  });
}

function showSelectionToast(message) {
  selectionToast.textContent = message;
  selectionToast.classList.add('show');
  if (toastTimeout) {
    clearTimeout(toastTimeout);
  }
  toastTimeout = setTimeout(() => selectionToast.classList.remove('show'), 1300);
}

function syncSelectionState() {
  const selectedIds = selectionManager ? selectionManager.selectedIds : new Set();
  document.querySelectorAll('.unit-marker[data-unit-id]').forEach((marker) => {
    marker.classList.toggle('selected', selectedIds.has(marker.dataset.unitId));
  });
  renderFleetRoster();
}

function toMapCoordinates(clientX, clientY) {
  const containerRect = mapContainer.getBoundingClientRect();
  return {
    x: (clientX - containerRect.left - mapState.panX) / mapState.zoom,
    y: (clientY - containerRect.top - mapState.panY) / mapState.zoom
  };
}

function resolveContextTarget(event) {
  const targetNode = event.target.closest('[data-entity-id]');
  if (targetNode) {
    const entity = mapEntityIndex.get(targetNode.dataset.entityId);
    if (entity) {
      if (entity.type === 'unit') {
        return {
          type: 'unit',
          id: entity.id,
          name: entity.callsign,
          callsign: entity.callsign,
          x: entity.x,
          y: entity.y,
          unitType: entity.unitType,
          ship: entity.ship,
          role: entity.role,
          status: entity.status,
          wing: entity.wing
        };
      }
      return {
        type: entity.type,
        id: entity.id,
        name: entity.name,
        x: entity.x,
        y: entity.y
      };
    }
  }
  const coords = toMapCoordinates(event.clientX, event.clientY);
  return {
    type: 'coordinates',
    id: `coord-${Math.round(coords.x)}-${Math.round(coords.y)}`,
    name: `GRID ${Math.round(coords.x)},${Math.round(coords.y)}`,
    x: coords.x,
    y: coords.y
  };
}

function buildRadialOptions(target) {
  const selectedUnits = selectionManager.getSelectedUnits();
  if (selectedUnits.length > 0) {
    const options = [
      { label: 'MOVE', verb: 'MOVE' },
      { label: 'HOLD', verb: 'HOLD' },
      { label: 'PATROL', verb: 'PATROL' },
      { label: 'MARK', verb: 'MARK' },
      { label: 'ROE', verb: 'ROE' }
    ];
    if (target.type === 'unit' && target.unitType === 'friendly') {
      options.push({ label: 'ESCORT', verb: 'ESCORT' });
    }
    if (target.type === 'unit' && target.unitType === 'hostile') {
      options.push({ label: 'ENGAGE', verb: 'ENGAGE', class: 'danger' });
    }
    if (['planet', 'moon', 'om-marker', 'lagrange', 'jump-point', 'zone'].includes(target.type)) {
      options.push({ label: 'SCAN', verb: 'SCAN', class: 'warning' });
    }
    return options;
  }
  return [
    { label: 'PING', verb: 'PING' },
    { label: 'MARK', verb: 'MARK' },
    { label: 'DRAW ZONE', verb: 'DRAW_ZONE' },
    { label: 'INFO', verb: 'INFO' }
  ];
}

// Show radial menu
function showRadialMenu(x, y, target) {
  const menu = document.getElementById('radialMenu');
  const options = buildRadialOptions(target);
  const selectedUnits = selectionManager.getSelectedUnits();

  menu.style.left = `${x}px`;
  menu.style.top = `${y}px`;
  menu.classList.add('active');
  mapState.activeCommandTarget = target;

  menu.querySelectorAll('.radial-option').forEach((opt) => opt.remove());
  if (selectedUnits.length > 0) {
    radialCenter.innerHTML = `${selectedUnits.length} UNIT${selectedUnits.length > 1 ? 'S' : ''}<br>${target.name}`;
  } else {
    radialCenter.innerHTML = `MAP TOOLS<br>${target.name}`;
  }

  const radius = 80;
  const step = 360 / options.length;
  options.forEach((opt, idx) => {
    const optEl = document.createElement('div');
    optEl.className = `radial-option ${opt.class || ''}`;
    const angleRad = (idx * step - 90) * Math.PI / 180;
    const optionX = 100 + radius * Math.cos(angleRad);
    const optionY = 100 + radius * Math.sin(angleRad);
    optEl.style.left = `${optionX}px`;
    optEl.style.top = `${optionY}px`;
    optEl.textContent = opt.label;
    optEl.onclick = (e) => {
      e.stopPropagation();
      executeOrder(opt.verb, target);
      hideRadialMenu();
    };
    menu.appendChild(optEl);
  });
}

// Hide radial menu
function hideRadialMenu() {
  radialMenu.classList.remove('active');
}

// Execute order
function executeOrder(verb, target) {
  const selectedUnits = selectionManager.getSelectedUnits();
  const nowIso = new Date().toISOString();
  const order = {
    id: `ord-${Date.now()}-${mapState.orderSequence++}`,
    createdAt: nowIso,
    issuer: 'COMMAND',
    selectionUnitIds: selectedUnits.map((unit) => unit.id),
    selectionLabel: selectedUnits.length ? selectionManager.getSelectionLabel() : 'MAP',
    verb,
    target: {
      type: target.type,
      id: target.id || null,
      name: target.name || 'UNSPECIFIED',
      x: typeof target.x === 'number' ? target.x : null,
      y: typeof target.y === 'number' ? target.y : null
    },
    params: {},
    state: ORDER_STATES.ISSUED
  };

  mapState.orders.unshift(order);
  if (mapState.orders.length > 60) {
    mapState.orders.length = 60;
  }
  mapState.pagers.orders = 0;
  refreshOrderPresentation();
  addCommsEntry('COMMAND', `Order ISSUED — ${getOrderSummary(order)}`);
}

function acknowledgeOrderForUnit(unitId) {
  const pendingOrder = getLatestPendingOrderForUnit(unitId);
  if (!pendingOrder) {
    return;
  }
  const unit = fleetUnitsById.get(unitId);
  const ackBy = unit ? unit.callsign : unitId.toUpperCase();
  pendingOrder.state = ORDER_STATES.ACKED;
  pendingOrder.ackAt = new Date().toISOString();
  pendingOrder.ackBy = ackBy;
  refreshOrderPresentation();
  addCommsEntry(ackBy, `ACK — ${getOrderSummary(pendingOrder)}`);
  showSelectionToast(`${ackBy} ACK ${getVerbCode(pendingOrder.verb)}`);
}

function cancelMostRecentOrder() {
  const latestOrder = mapState.orders[0];
  if (!latestOrder || latestOrder.state === ORDER_STATES.CANCELLED) {
    return;
  }
  latestOrder.state = ORDER_STATES.CANCELLED;
  latestOrder.cancelledAt = new Date().toISOString();
  latestOrder.cancelledBy = 'COMMAND';
  refreshOrderPresentation();
  addCommsEntry('COMMAND', `Order CANCELLED — ${getOrderSummary(latestOrder)}`);
}

// Add comms entry
function addCommsEntry(sender, msg) {
  mapState.commsLog.unshift({
    createdAt: new Date().toISOString(),
    sender,
    msg
  });
  if (mapState.commsLog.length > 80) {
    mapState.commsLog.length = 80;
  }
  mapState.pagers.comms = 0;
  renderCommsLog();
}

// Center on object
function centerOnObject(obj) {
  const containerRect = mapContainer.getBoundingClientRect();
  mapState.panX = containerRect.width / 2 - obj.x * mapState.zoom;
  mapState.panY = containerRect.height / 2 - obj.y * mapState.zoom;
  updateMapTransform();
}

function centerOnSelectionBounds(units) {
  if (!units || units.length === 0) {
    return;
  }
  const minX = Math.min(...units.map((unit) => unit.x));
  const maxX = Math.max(...units.map((unit) => unit.x));
  const minY = Math.min(...units.map((unit) => unit.y));
  const maxY = Math.max(...units.map((unit) => unit.y));
  const centerX = (minX + maxX) / 2;
  const centerY = (minY + maxY) / 2;
  const containerRect = mapContainer.getBoundingClientRect();

  const width = Math.max(120, maxX - minX + 120);
  const height = Math.max(120, maxY - minY + 120);
  const fitZoom = Math.max(mapState.minZoom, Math.min(mapState.maxZoom, Math.min(containerRect.width / width, containerRect.height / height)));
  mapState.zoom = Math.min(mapState.zoom, fitZoom);
  mapState.panX = containerRect.width / 2 - centerX * mapState.zoom;
  mapState.panY = containerRect.height / 2 - centerY * mapState.zoom;
  updateMapTransform();
}

// Update map transform
function updateMapTransform() {
  mapContent.style.transform = `translate(${mapState.panX}px, ${mapState.panY}px) scale(${mapState.zoom})`;
  updateMinimapViewport();
  updateScaleIndicator();
}

// Update scale indicator
function updateScaleIndicator() {
  const baseScale = 500000; // 500,000 km at zoom 1
  const currentScale = Math.round(baseScale / mapState.zoom);
  const indicator = document.getElementById('scaleIndicator');
  
  if (currentScale >= 1000000) {
    indicator.textContent = (currentScale / 1000000).toFixed(1) + 'M km';
  } else {
    indicator.textContent = currentScale.toLocaleString() + ' km';
  }
}

function isInteractiveMapNode(target) {
  return Boolean(target.closest('.unit-marker, .celestial-body, .om-marker, .lagrange-point, .jump-point, .radial-menu'));
}

function startSelectionBox(clientX, clientY, additive) {
  mapState.isBoxSelecting = true;
  mapState.boxAdditive = additive;
  mapState.boxStartX = clientX;
  mapState.boxStartY = clientY;
  mapState.boxCurrentX = clientX;
  mapState.boxCurrentY = clientY;
  selectionMarquee.style.display = 'block';
  updateSelectionBox(clientX, clientY);
}

function updateSelectionBox(clientX, clientY) {
  mapState.boxCurrentX = clientX;
  mapState.boxCurrentY = clientY;
  const containerRect = mapContainer.getBoundingClientRect();
  const left = Math.min(mapState.boxStartX, clientX) - containerRect.left;
  const top = Math.min(mapState.boxStartY, clientY) - containerRect.top;
  const width = Math.abs(mapState.boxStartX - clientX);
  const height = Math.abs(mapState.boxStartY - clientY);
  selectionMarquee.style.left = `${left}px`;
  selectionMarquee.style.top = `${top}px`;
  selectionMarquee.style.width = `${width}px`;
  selectionMarquee.style.height = `${height}px`;
}

function finishSelectionBox() {
  if (!mapState.isBoxSelecting) {
    return;
  }

  const minClientX = Math.min(mapState.boxStartX, mapState.boxCurrentX);
  const maxClientX = Math.max(mapState.boxStartX, mapState.boxCurrentX);
  const minClientY = Math.min(mapState.boxStartY, mapState.boxCurrentY);
  const maxClientY = Math.max(mapState.boxStartY, mapState.boxCurrentY);
  const width = maxClientX - minClientX;
  const height = maxClientY - minClientY;
  selectionMarquee.style.display = 'none';
  mapState.isBoxSelecting = false;

  if (width < 4 || height < 4) {
    return;
  }

  const containerRect = mapContainer.getBoundingClientRect();
  const minMapX = (minClientX - containerRect.left - mapState.panX) / mapState.zoom;
  const maxMapX = (maxClientX - containerRect.left - mapState.panX) / mapState.zoom;
  const minMapY = (minClientY - containerRect.top - mapState.panY) / mapState.zoom;
  const maxMapY = (maxClientY - containerRect.top - mapState.panY) / mapState.zoom;

  const selectedIds = fleetUnits
    .filter((unit) =>
      unit.type === 'friendly' &&
      unit.x >= minMapX && unit.x <= maxMapX &&
      unit.y >= minMapY && unit.y <= maxMapY
    )
    .map((unit) => unit.id);

  selectionManager.setSelection(selectedIds, mapState.boxAdditive ? 'append' : 'replace');
  showSelectionToast(`SELECT ${selectionManager.getSelectionLabel()}`);
}

function isTypingTarget(target) {
  return Boolean(
    target &&
    (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable)
  );
}

// Setup event listeners
function setupEventListeners() {
  /*
    QA checklist:
    - No scrollbars anywhere (page or panel lists).
    - Orders render as overlays and follow map pan/zoom transforms.
    - Issued orders appear in overlays, unit badges, roster state, recent orders, and comms log.
    - ACK updates order state and is reflected across overlays, badges, roster, orders, and comms.
    - Right-click issue, left-click selection, and map pan/zoom all remain functional.
  */

  const bindPager = (stateKey, renderer, prevId, nextId) => {
    document.getElementById(prevId).addEventListener('click', () => {
      if (mapState.pagers[stateKey] > 0) {
        mapState.pagers[stateKey] -= 1;
        renderer();
      }
    });
    document.getElementById(nextId).addEventListener('click', () => {
      mapState.pagers[stateKey] += 1;
      renderer();
    });
  };

  bindPager('roster', renderFleetRoster, 'fleetRosterPrev', 'fleetRosterNext');
  bindPager('orders', renderRecentOrders, 'ordersPrev', 'ordersNext');
  bindPager('comms', renderCommsLog, 'commsPrev', 'commsNext');
  document.getElementById('cancelLatestOrder').addEventListener('click', () => {
    cancelMostRecentOrder();
  });

  document.querySelectorAll('[data-select-by]').forEach((chip) => {
    chip.addEventListener('click', () => {
      selectionManager.cycleFilter(chip.dataset.selectBy);
    });
  });

  // Pan
  mapContainer.addEventListener('mousedown', (e) => {
    if (e.button !== 0) {
      return;
    }

    if (e.ctrlKey) {
      e.preventDefault();
      hideRadialMenu();
      mapState.isDragging = false;
      startSelectionBox(e.clientX, e.clientY, e.shiftKey);
      return;
    }

    if (!isInteractiveMapNode(e.target)) {
      mapState.isDragging = true;
      mapState.lastX = e.clientX;
      mapState.lastY = e.clientY;
      hideRadialMenu();
    }
  });
  
  document.addEventListener('mousemove', (e) => {
    // Update cursor coords
    const containerRect = mapContainer.getBoundingClientRect();
    if (e.clientX >= containerRect.left && e.clientX <= containerRect.right && e.clientY >= containerRect.top && e.clientY <= containerRect.bottom) {
      const mapX = (e.clientX - containerRect.left - mapState.panX) / mapState.zoom;
      const mapY = (e.clientY - containerRect.top - mapState.panY) / mapState.zoom;
      document.getElementById('cursorCoords').textContent = 
        `X: ${mapX.toFixed(0)} | Y: ${mapY.toFixed(0)} | Z: 0.00`;
    }

    if (mapState.isBoxSelecting) {
      updateSelectionBox(e.clientX, e.clientY);
      return;
    }
    
    if (mapState.isDragging) {
      const dx = e.clientX - mapState.lastX;
      const dy = e.clientY - mapState.lastY;
      mapState.panX += dx;
      mapState.panY += dy;
      mapState.lastX = e.clientX;
      mapState.lastY = e.clientY;
      updateMapTransform();
    }
  });
  
  document.addEventListener('mouseup', () => {
    finishSelectionBox();
    mapState.isDragging = false;
  });

  mapContainer.addEventListener('click', (e) => {
    if (!isInteractiveMapNode(e.target) && !e.shiftKey && !e.ctrlKey) {
      selectionManager.clear();
      mapState.selectedObject = null;
      updateSelectedInfo(null);
    }
  });

  mapContainer.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    const target = resolveContextTarget(e);
    mapState.activeCommandTarget = target;
    updateSelectedInfo(target);
    showRadialMenu(e.clientX, e.clientY, target);
  });
  
  // Zoom
  mapContainer.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? 0.9 : 1.1;
    const newZoom = Math.max(mapState.minZoom, Math.min(mapState.maxZoom, mapState.zoom * delta));
    
    // Zoom toward cursor
    const containerRect = mapContainer.getBoundingClientRect();
    const mouseX = e.clientX - containerRect.left;
    const mouseY = e.clientY - containerRect.top;
    
    const zoomRatio = newZoom / mapState.zoom;
    mapState.panX = mouseX - (mouseX - mapState.panX) * zoomRatio;
    mapState.panY = mouseY - (mouseY - mapState.panY) * zoomRatio;
    mapState.zoom = newZoom;
    
    updateMapTransform();
  });
  
  // Zoom buttons
  document.getElementById('zoomIn').onclick = () => {
    mapState.zoom = Math.min(mapState.maxZoom, mapState.zoom * 1.2);
    updateMapTransform();
  };
  
  document.getElementById('zoomOut').onclick = () => {
    mapState.zoom = Math.max(mapState.minZoom, mapState.zoom / 1.2);
    updateMapTransform();
  };
  
  document.getElementById('zoomReset').onclick = () => {
    mapState.zoom = 1;
    mapState.panX = 0;
    mapState.panY = 0;
    updateMapTransform();
  };
  
  // Layer toggles
  document.querySelectorAll('.layer-btn[data-layer]').forEach(btn => {
    btn.addEventListener('click', () => {
      const layer = btn.dataset.layer;
      mapState.layers[layer] = !mapState.layers[layer];
      btn.classList.toggle('active', mapState.layers[layer]);
      updateLayerVisibility();
    });
  });
  
  // View mode toggles
  document.querySelectorAll('.layer-btn[data-view]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.layer-btn[data-view]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      mapState.viewMode = btn.dataset.view;
    });
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      selectionManager.clear();
      hideRadialMenu();
      return;
    }

    if (isTypingTarget(e.target)) {
      return;
    }

    if (/^[1-9]$/.test(e.key)) {
      const slot = Number(e.key);
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        selectionManager.assignGroup(slot);
      } else {
        e.preventDefault();
        selectionManager.recallGroup(slot);
      }
    }
  });
  
  // Close radial menu on click outside
  document.addEventListener('click', (e) => {
    if (!radialMenu.contains(e.target)) {
      hideRadialMenu();
    }
  });
  
  // Broadcast
  document.getElementById('broadcastBtn').onclick = () => {
    const input = document.getElementById('broadcastInput');
    if (input.value.trim()) {
      addCommsEntry(config.fleet_callsign, input.value.trim());
      input.value = '';
    }
  };
  
  document.getElementById('broadcastInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('broadcastBtn').click();
    }
  });
}

// Update layer visibility
function updateLayerVisibility() {
  const celestials = document.querySelectorAll('.celestial-body, .orbit-ring');
  const markers = document.querySelectorAll('.om-marker, .lagrange-point, .jump-point');
  const units = document.querySelectorAll('.unit-marker');
  const commsSvg = document.getElementById('commsSvg');
  const zonesSvg = document.getElementById('zonesSvg');
  
  celestials.forEach(el => el.style.display = mapState.layers.celestial ? '' : 'none');
  markers.forEach(el => el.style.display = mapState.layers.markers ? '' : 'none');
  units.forEach(el => el.style.display = mapState.layers.units ? '' : 'none');
  
  // Render comms network if enabled
  if (mapState.layers.comms) {
    renderCommsNetwork();
    commsSvg.style.display = '';
  } else {
    commsSvg.style.display = 'none';
  }
  
  // Render zones if enabled
  if (mapState.layers.zones) {
    renderZones();
    zonesSvg.style.display = '';
  } else {
    zonesSvg.style.display = 'none';
  }
}

// Render comms network
function renderCommsNetwork() {
  const svg = document.getElementById('commsSvg');
  svg.innerHTML = '';
  
  const friendlyUnits = fleetUnits.filter(u => u.type === 'friendly');
  
  // Connect all friendly units
  for (let i = 0; i < friendlyUnits.length; i++) {
    for (let j = i + 1; j < friendlyUnits.length; j++) {
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', friendlyUnits[i].x);
      line.setAttribute('y1', friendlyUnits[i].y);
      line.setAttribute('x2', friendlyUnits[j].x);
      line.setAttribute('y2', friendlyUnits[j].y);
      line.setAttribute('class', 'comms-line');
      svg.appendChild(line);
    }
  }
}

// Render zones
function renderZones() {
  const svg = document.getElementById('zonesSvg');
  svg.innerHTML = '';
  
  // Example combat zone around Crusader
  const zone = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  zone.setAttribute('cx', '1500');
  zone.setAttribute('cy', '900');
  zone.setAttribute('r', '150');
  zone.setAttribute('fill', 'rgba(255, 0, 0, 0.15)');
  zone.setAttribute('stroke', 'var(--danger)');
  zone.setAttribute('stroke-width', '2');
  zone.setAttribute('stroke-dasharray', '10, 5');
  svg.appendChild(zone);
  
  // Zone label
  const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  text.setAttribute('x', '1500');
  text.setAttribute('y', '750');
  text.setAttribute('text-anchor', 'middle');
  text.setAttribute('fill', 'var(--danger)');
  text.setAttribute('font-size', '12');
  text.setAttribute('font-family', 'Share Tech Mono');
  text.textContent = 'ACTIVE COMBAT ZONE';
  svg.appendChild(text);
}

// Start clock
function startClock() {
  function updateClock() {
    const now = new Date();
    const year = 2954;
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const time = now.toLocaleTimeString('en-US', { hour12: false });
    document.getElementById('systemTime').textContent = `${year}.${month}.${day} // ${time} SET`;
  }
  
  updateClock();
  setInterval(updateClock, 1000);
}

// Apply config changes
function applyConfig() {
  document.getElementById('operationName').textContent = config.map_title;
  document.getElementById('fleetCallsign').textContent = config.fleet_callsign;
  
  // Update CSS variables
  document.documentElement.style.setProperty('--primary', config.primary_color);
  document.documentElement.style.setProperty('--secondary', config.secondary_color);
  document.documentElement.style.setProperty('--accent', config.accent_color);
  document.documentElement.style.setProperty('--text', config.text_color);
  document.documentElement.style.setProperty('--warning', config.warning_color);
}

// Element SDK Integration
if (window.elementSdk) {
  window.elementSdk.init({
    defaultConfig,
    onConfigChange: async (newConfig) => {
      config = { ...defaultConfig, ...newConfig };
      applyConfig();
    },
    mapToCapabilities: (cfg) => ({
      recolorables: [
        {
          get: () => cfg.primary_color || defaultConfig.primary_color,
          set: (v) => window.elementSdk.setConfig({ primary_color: v })
        },
        {
          get: () => cfg.secondary_color || defaultConfig.secondary_color,
          set: (v) => window.elementSdk.setConfig({ secondary_color: v })
        },
        {
          get: () => cfg.accent_color || defaultConfig.accent_color,
          set: (v) => window.elementSdk.setConfig({ accent_color: v })
        },
        {
          get: () => cfg.text_color || defaultConfig.text_color,
          set: (v) => window.elementSdk.setConfig({ text_color: v })
        },
        {
          get: () => cfg.warning_color || defaultConfig.warning_color,
          set: (v) => window.elementSdk.setConfig({ warning_color: v })
        }
      ],
      borderables: [],
      fontEditable: undefined,
      fontSizeable: undefined
    }),
    mapToEditPanelValues: (cfg) => new Map([
      ['map_title', cfg.map_title || defaultConfig.map_title],
      ['fleet_callsign', cfg.fleet_callsign || defaultConfig.fleet_callsign]
    ])
  });
} else {
  applyConfig();
}

// Initialize
initMap();
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cd6d0ae652e2c71',t:'MTc3MTAxMTgxMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
